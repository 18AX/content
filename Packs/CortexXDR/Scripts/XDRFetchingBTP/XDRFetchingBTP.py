import copy
import demistomock as demisto  # noqa: F401
from CommonServerPython import *  # noqa: F401


def decode_dict_values(dict_to_decode: dict):
    for key in dict_to_decode.keys():
        # if value if a dictionary, we want to recursively decode it's values
        if isinstance(dict_to_decode[key], dict):
            decode_dict_values(dict_to_decode[key])
        # if value if a string, we want to try to decode it, if it cannot be decoded, we will move on.
        elif isinstance(dict_to_decode[key], str):
            try:
                dict_to_decode[key] = json.loads(dict_to_decode[key])
            except Exception:
                continue
    return


def filter_alerts(alerts: dict):
    filtered_alerts = []

    for i, alert in enumerate(alerts):
        internal_id = alert.get('internal_id')
        filtered_fields = {'internal_id': internal_id, 'file_operation': [], 'process_start': []}
        internals = list(dict_safe_get(alert, ['messageData', 'dynamicAnalysis', 'internals'],
                                       default_return_value=[],
                                       return_type=list))
        for internal in internals:
            if internal.get('name') == 'file_operation':
                attr = internal.get('attributes')
                if attr:
                    filtered_fields['file_operation'].append({
                        'actor_instance_id': attr.get('actor_instance_id'),
                        'pid': attr.get('pid'),
                        'file_path_hash': attr.get('file_path_hash'),
                        'remote_causality_actor_ip': attr.get('file_path_hash'),
                        'file_path': attr.get('file_path_hash'),
                        'sub_type': attr.get('file_path_hash'),
                        'causality_actor_type': attr.get('file_path_hash'),
                        'cid': attr.get('file_path_hash'),
                        'actor_type': attr.get('file_path_hash'),
                        'event_id': attr.get('file_path_hash'),
                    })

            if internal.get('name') == 'process_start':
                attr = internal.get('attributes')
                if attr:
                    filtered_fields['process_start'].append({
                        'command_line': attr.get('command_line'),
                        'image_path_sha256': attr.get('image_path_sha256'),
                        'file_info_company_name': attr.get('file_info_company_name'),
                        'file_info_original_name': attr.get('file_info_original_name'),
                        'instance_id': attr.get('instance_id'),
                        'signer_name': attr.get('signer_name'),
                        'original_command_line': attr.get('original_command_line'),
                        'remote_causality_actor_ip': attr.get('remote_causality_actor_ip'),
                        'causality_actor_type': attr.get('causality_actor_type'),
                        'cid': attr.get('cid'),
                        'actor_type': attr.get('actor_type'),
                        'process_image_name': attr.get('process_image_name'),
                        'is_sign': attr.get('is_sign'),
                        'is_remote_session': attr.get('is_remote_session'),
                        'process_image_path': attr.get('process_image_path'),
                    })
            # append dict to list only if the filtered_fields dict is not empty
        if filtered_fields:
            filtered_alerts.append(filtered_fields)
    return filtered_alerts


def decode_alerts(alerts):
    for alert in alerts:
        try:
            alert['original_alert_json'] = safe_load_json(alert.get('original_alert_json', ''))
            # some of the returned JSON fields are double encoded, so it needs to be double-decoded.
            # example: {"x": "someValue", "y": "{\"z\":\"anotherValue\"}"}
            decode_dict_values(alert)
        except Exception:
            continue
        # remove original_alert_json field and add its content to alert.
        alert.update(alert.pop('original_alert_json', None))


def create_readable_format(alerts: list) -> str:
    readable_output = '## XDR BTP Alerts\n'
    for alert in alerts:
        readable_output += '### Alert ID\n' + \
                           str(alert.get('internal_id')) + '\n#### File Operation\n' + \
                           tableToMarkdown('', alert.get('file_operation', ''), removeNull=True,
                                           headerTransform=string_to_table_header) + '\n#### Process Start\n' + \
                           tableToMarkdown('', alert.get('process_start', ''), removeNull=True,
                                           headerTransform=string_to_table_header) + '\n'
    return readable_output


def main():
    try:
        args = demisto.args()
        alert_id_list = argToList(args.get('alert_id_list', None))

        raw_response = execute_command('xdr-generic-api-execution',
                                       args={'method': 'POST',
                                             'api_endpoint': '/alerts/get_original_alerts/',
                                             'request_data': {
                                                 'alert_id_list': alert_id_list
                                             }
                                             }
                                       )
        # raw_response = {"reply": {"alerts": [{"internal_id": 2,
        #                                       "original_alert_json": "{\"uuid\":\"7746a019d98f4dc6a1680eed42f7817b\",\"recordType\":\"threat\",\"customerId\":\"9996491305873\",\"severity\":3,\"generatedTime\":\"2021-08-04T11:59:28.912000Z\",\"originalAgentTime\":\"2021-08-04T11:59:28.465286Z\",\"serverTime\":\"2021-08-04T11:59:30.719746\",\"isEndpoint\":1,\"agentId\":\"7ec89bbb3d9b478dbc176814c133e643\",\"endPointHeader\":{\"osVersion\":\"10.0.10240\",\"agentIp\":\"10.208.254.69\",\"deviceName\":\"DESKTOP-84QH963\",\"agentVersion\":\"7.5.0.27877\",\"contentVersion\":\"192-67380\",\"policyTag\":\"YTdiN2NkOWQyMmViMDY0ZjgyNDdhODlkZGIzN2FjZDEzZDJlMzE4N2NkYzQ5YmVlZTI2ODVlZmY1MjdmYmMwNTpGYWxzZTpESVNBQkxFRDpMSUNFTlNFXzIwX1BSRVZFTlQ=\",\"securityStatus\":0,\"protectionStatus\":0,\"dataCollectionStatus\":0,\"isolationStatus\":0,\"agentIpList\":[\"10.208.254.69\"],\"addresses\":[{\"ip\":[\"10.208.254.69\"],\"mac\":\"00:50:56:89:7b:e8\"}],\"liveTerminalEnabled\":true,\"scriptExecutionEnabled\":true,\"fileRetrievalEnabled\":true,\"agentLocation\":0,\"fileSearchEnabled\":false,\"deviceDomain\":\"WORKGROUP\",\"userName\":\"user\",\"userSid\":\"S-1-5-21-3253057499-604248399-3554933422-1003\",\"osType\":1,\"is64\":1,\"isVdi\":0,\"agentId\":\"7ec89bbb3d9b478dbc176814c133e643\",\"agentTime\":\"2021-08-04T11:59:28.912000Z\",\"tzOffset\":-180},\"messageData\":{\"eventCategory\":\"prevention\",\"moduleId\":\"COMPONENT_DSE\",\"moduleStatusId\":\"CYSTATUS_DSE\",\"preventionKey\":\"8273f1ee45954a028f6378a5b119c4f7\",\"processes\":[{\"pid\":2756,\"parentId\":3324,\"exeFileIdx\":0,\"userIdx\":0,\"commandLine\":\"\\\"C:\\\\Portable\\\\pestudio\\\\svchost.exe\\\" \",\"instanceId\":\"AdeJKC1osnkAAArEAAAAAA==\",\"terminated\":1,\"terminationReportId\":\"68551ca39deb43218d8a2b6a6495d97b\"}],\"files\":[{\"rawFullPath\":\"C:\\\\Portable\\\\pestudio\\\\svchost.exe\",\"fileName\":\"svchost.exe\",\"sha256\":\"c80aa7d807890269968b3a4d00e347a756039d04545e75c312499105c069cf60\",\"fileSize\":\"565248\",\"companyName\":\"www.winitor.com\"}],\"users\":[{\"userName\":\"user\",\"domainUser\":\"user\"}],\"urls\":[],\"postDetected\":0,\"sockets\":[],\"containers\":[],\"dynamicAnalysis\":{\"causalityId\":\"AdeJKC1osnkAAArEAAAAAA==\",\"internals\":[{\"name\":\"process_start\",\"factName\":\"process_start\",\"timestamp\":\"2021-08-04T11:59:28.436046Z\",\"eventId\":\"AAABexEIZrRkwDJLAADHgg==\",\"attributes\":{\"is_cgo\":\"1\",\"parent_cid\":\"\",\"enabled_privileges\":\"8388608\",\"peb32\":\"2127228928\",\"is_embedded_sign\":\"0\",\"rpc_function_opnum\":\"nil\",\"parent_thread_instance_id\":\"AAAAAAAAAAAAAAAAAAAAAA==\",\"remote_causality_actor_ip\":\"nil\",\"canonized_process_image_path\":\"%systemdrive%\\\\portable\\\\pestudio\\\\svchost.exe\",\"scanned_buffer_crc32_stacktrace_call_region_buffer\":\"nil\",\"yara_rules_results_stacktrace_allocation_base_buffer\":\"nil\",\"entry_point_rva\":\"307331\",\"is_stack_pivot\":\"nil\",\"os_parent_pid\":\"3324\",\"image_path_md5\":\"e34f6d6ce26eddd05488219574f9c83f\",\"causality_actor_type\":\"1\",\"timestamp\":\"16280783684360460\",\"is_in_transaction\":\"0\",\"cid\":\"AdeJKC1osnkAAArEAAAAAA==\",\"file_info_description\":\"malware initial assessment - www.winitor.com\",\"actor_type\":\"1\",\"integrity_level\":\"8192\",\"chisq_prob\":\"0\",\"parent_tid\":\"5660\",\"rpc_interface_major_version\":\"nil\",\"dse_internal\":\"nil\",\"process_image_name\":\"svchost.exe\",\"parent_instance_id\":\"AdcwYRSqeNQAAAz8AAAAAA==\",\"entropy\":\"0.791\",\"call_region_base_address\":\"nil\",\"yara_rules_results_stacktrace_call_region_buffer\":\"nil\",\"scanned_buffer_crc32_stacktrace_page_base_buffer\":\"nil\",\"image_base\":\"4063232\",\"sync_id\":\"nil\",\"effective_user_sid\":\"S-1-5-21-3253057499-604248399-3554933422-1003\",\"requested_parent_pid\":\"3324\",\"event_id\":\"AAABexEIZrRkwDJLAADHgg==\",\"rpc_protocol\":\"nil\",\"user_presence\":\"2\",\"shellcode_address\":\"nil\",\"tid\":\"5660\",\"parent_pid\":\"3324\",\"is_sign\":\"3\",\"sync_action\":\"nil\",\"is_remote_session\":\"0\",\"peb\":\"2127192064\",\"process_image_path\":\"c:\\\\portable\\\\pestudio\\\\svchost.exe\",\"command_line\":\"\\\"c:\\\\portable\\\\pestudio\\\\svchost.exe\\\" \",\"scanned_buffer_crc32_stacktrace_allocation_base_buffer\":\"nil\",\"page_base_shellcode_buffer\":\"nil\",\"user_name\":\"desktop-84qh963\\\\user\",\"file_info_legal_copyright\":\"copyright \\u00a9 2009-2019 marc ochsenmeier\",\"os_sig_status\":\"0\",\"is_heavens_gate\":\"nil\",\"is_impersonated\":\"0\",\"os_parent_instance_id\":\"AdcwYRSqeNQAAAz8AAAAAA==\",\"file_info_internal_name\":\"pestudio.exe\",\"stack_trace\":\"nil\",\"is_injected\":\"0\",\"pid\":\"2756\",\"image_path_sha256\":\"c80aa7d807890269968b3a4d00e347a756039d04545e75c312499105c069cf60\",\"thread_context_eip_image_path\":\"nil\",\"montepi_err\":\"0.00908\",\"file_info_company_name\":\"www.winitor.com\",\"file_info_original_name\":\"pestudio.exe\",\"instance_id\":\"AdeJKC1osnkAAArEAAAAAA==\",\"file_obj_flags\":\"704374898754\",\"call_region_shellcode_buffer\":\"nil\",\"file_size\":\"565248\",\"should_obfuscate\":\"0\",\"allocation_base_shellcode_buffer\":\"nil\",\"signer_name\":\"nil\",\"original_command_line\":\"\\\"C:\\\\Portable\\\\pestudio\\\\svchost.exe\\\" \",\"rpc_interface_uuid\":\"nil\",\"yara_rules_results_stacktrace_page_base_buffer\":\"nil\",\"rpc_interface_minor_version\":\"nil\",\"telem\":\"nil\",\"is_trusted_signer\":\"nil\",\"thread_context_eip\":\"nil\",\"requested_parent_instance_id\":\"AdcwYRSqeNQAAAz8AAAAAA==\"},\"processIdx\":0,\"instanceId\":\"AdeJKC1osnkAAArEAAAAAA==\"},{\"name\":\"file_operation\",\"factName\":\"file_operation\",\"timestamp\":\"2021-08-04T11:59:26.748441Z\",\"eventId\":\"AAABexEIYBxkwDJLAADHeQ==\",\"attributes\":{\"shellcode_address\":\"nil\",\"tid\":\"5176\",\"file_type\":\"18\",\"sync_action\":\"nil\",\"actor_pid\":\"3324\",\"scanned_buffer_crc32_stacktrace_allocation_base_buffer\":\"nil\",\"actor_instance_id\":\"AdcwYRSqeNQAAAz8AAAAAA==\",\"page_base_shellcode_buffer\":\"nil\",\"is_heavens_gate\":\"nil\",\"is_impersonated\":\"0\",\"reparse_path\":\"\",\"modification_time\":\"nil\",\"dirty_reason\":\"0\",\"access_time\":\"nil\",\"stack_trace\":\"nil\",\"pid\":\"3324\",\"is_injected\":\"0\",\"thread_context_eip_image_path\":\"nil\",\"actor_thread_instance_id\":\"AAAAAAAAAAAAAAAAAAAAAA==\",\"montepi_err\":\"-1\",\"instance_id\":\"AdcwYRSqeNQAAAz8AAAAAA==\",\"file_size\":\"18446744073709551615\",\"call_region_shellcode_buffer\":\"nil\",\"should_obfuscate\":\"0\",\"create_time\":\"nil\",\"allocation_base_shellcode_buffer\":\"nil\",\"yara_rules_results_stacktrace_page_base_buffer\":\"nil\",\"rpc_interface_uuid\":\"nil\",\"file_name\":\"svchost.exe\",\"file_extension\":\"exe\",\"rpc_interface_minor_version\":\"nil\",\"telem\":\"nil\",\"canonized_file_path\":\"%systemdrive%\\\\portable\\\\pestudio\\\\svchost.exe\",\"file_path_hash\":\"\",\"thread_context_eip\":\"nil\",\"attributes\":\"0\",\"sec_desc\":\"\",\"file_path_md5\":\"\",\"reparse_count\":\"0\",\"rpc_function_opnum\":\"nil\",\"remote_causality_actor_ip\":\"nil\",\"is_remote_file\":\"0\",\"scanned_buffer_crc32_stacktrace_call_region_buffer\":\"nil\",\"yara_rules_results_stacktrace_allocation_base_buffer\":\"nil\",\"old_file_name\":\"pestudio - copy.exe\",\"is_stack_pivot\":\"nil\",\"file_path\":\"c:\\\\portable\\\\pestudio\\\\svchost.exe\",\"sub_type\":\"3\",\"causality_actor_type\":\"1\",\"timestamp\":\"16280783667484410\",\"cid\":\"AdcwYRSqeNQAAAz8AAAAAA==\",\"actor_type\":\"1\",\"chisq_prob\":\"-1\",\"rpc_interface_major_version\":\"nil\",\"dse_internal\":\"nil\",\"old_file_path\":\"c:\\\\portable\\\\pestudio\\\\pestudio - copy.exe\",\"actor_tid\":\"5176\",\"entropy\":\"-1\",\"call_region_base_address\":\"nil\",\"yara_rules_results_stacktrace_call_region_buffer\":\"nil\",\"scanned_buffer_crc32_stacktrace_page_base_buffer\":\"nil\",\"canonized_old_file_path\":\"%systemdrive%\\\\portable\\\\pestudio\\\\pestudio - copy.exe\",\"sync_id\":\"nil\",\"event_id\":\"AAABexEIYBxkwDJLAADHeQ==\",\"rpc_protocol\":\"nil\"},\"processIdx\":-1,\"instanceId\":\"AdcwYRSqeNQAAAz8AAAAAA==\"},{\"name\":\"process_start\",\"factName\":\"process_start\",\"timestamp\":\"2021-04-13T12:32:34.739630Z\",\"eventId\":\"AAABeMs4GbNkwDJLAAAF/A==\",\"attributes\":{\"is_cgo\":\"1\",\"parent_cid\":\"\",\"enabled_privileges\":\"8388608\",\"peb32\":\"0\",\"is_embedded_sign\":\"1\",\"rpc_function_opnum\":\"nil\",\"parent_thread_instance_id\":\"AAAAAAAAAAAAAAAAAAAAAA==\",\"remote_causality_actor_ip\":\"nil\",\"canonized_process_image_path\":\"%windir%\\\\explorer.exe\",\"scanned_buffer_crc32_stacktrace_call_region_buffer\":\"nil\",\"yara_rules_results_stacktrace_allocation_base_buffer\":\"nil\",\"entry_point_rva\":\"653472\",\"is_stack_pivot\":\"nil\",\"os_parent_pid\":\"3252\",\"image_path_md5\":\"10e4809ba77d58392c742097dd61e1a6\",\"causality_actor_type\":\"1\",\"timestamp\":\"16183171547396300\",\"is_in_transaction\":\"0\",\"cid\":\"AdcwYRSqeNQAAAz8AAAAAA==\",\"file_info_description\":\"windows explorer\",\"actor_type\":\"1\",\"integrity_level\":\"8192\",\"chisq_prob\":\"0\",\"parent_tid\":\"4294967295\",\"rpc_interface_major_version\":\"nil\",\"dse_internal\":\"nil\",\"process_image_name\":\"explorer.exe\",\"parent_instance_id\":\"AdcwYRSbqvQAAAy0AAAAAA==\",\"entropy\":\"0.738\",\"call_region_base_address\":\"nil\",\"yara_rules_results_stacktrace_call_region_buffer\":\"nil\",\"scanned_buffer_crc32_stacktrace_page_base_buffer\":\"nil\",\"image_base\":\"140698412187648\",\"sync_id\":\"nil\",\"effective_user_sid\":\"S-1-5-21-3253057499-604248399-3554933422-1003\",\"requested_parent_pid\":\"3252\",\"event_id\":\"AAABeMs4GbNkwDJLAAAF/A==\",\"rpc_protocol\":\"nil\",\"user_presence\":\"0\",\"shellcode_address\":\"nil\",\"tid\":\"4294967295\",\"parent_pid\":\"3252\",\"is_sign\":\"1\",\"sync_action\":\"nil\",\"is_remote_session\":\"0\",\"peb\":\"140698407071744\",\"process_image_path\":\"c:\\\\windows\\\\explorer.exe\",\"command_line\":\"c:\\\\windows\\\\explorer.exe\",\"scanned_buffer_crc32_stacktrace_allocation_base_buffer\":\"nil\",\"page_base_shellcode_buffer\":\"nil\",\"user_name\":\"desktop-84qh963\\\\user\",\"file_info_legal_copyright\":\"\\u00a9 microsoft corporation. all rights reserved.\",\"os_sig_status\":\"2\",\"is_heavens_gate\":\"nil\",\"is_impersonated\":\"0\",\"os_parent_instance_id\":\"AdcwYRSbqvQAAAy0AAAAAA==\",\"file_info_internal_name\":\"explorer\",\"stack_trace\":\"nil\",\"is_injected\":\"0\",\"pid\":\"3324\",\"image_path_sha256\":\"4c36f49d7e09f39b9034a24b9ee496e8f4dc3044a89514dc890e139708fc94f6\",\"thread_context_eip_image_path\":\"nil\",\"montepi_err\":\"0.0749\",\"file_info_company_name\":\"microsoft corporation\",\"file_info_original_name\":\"explorer.exe\",\"instance_id\":\"AdcwYRSqeNQAAAz8AAAAAA==\",\"file_obj_flags\":\"704374915138\",\"call_region_shellcode_buffer\":\"nil\",\"file_size\":\"4533320\",\"should_obfuscate\":\"0\",\"allocation_base_shellcode_buffer\":\"nil\",\"signer_name\":\"Microsoft Corporation\",\"original_command_line\":\"C:\\\\Windows\\\\Explorer.EXE\",\"rpc_interface_uuid\":\"nil\",\"yara_rules_results_stacktrace_page_base_buffer\":\"nil\",\"rpc_interface_minor_version\":\"nil\",\"telem\":\"nil\",\"is_trusted_signer\":\"0\",\"thread_context_eip\":\"nil\",\"requested_parent_instance_id\":\"AdcwYRSbqvQAAAy0AAAAAA==\"},\"processIdx\":-1,\"instanceId\":\"AdcwYRSqeNQAAAz8AAAAAA==\"},{\"name\":\"internal.debug_build_timestamp\",\"factName\":\"internal.debug_build_timestamp\",\"timestamp\":\"2021-04-13T12:31:57.022749Z\",\"eventId\":\"\",\"attributes\":{\"timestamp\":\"16183171170227490\",\"cid\":\"AdcwYP4vVSsAAAAEAAAAAA==\",\"prio\":\"1000\",\"build_timestamp\":\"1627909023\"},\"processIdx\":-1,\"instanceId\":\"\"}],\"potentialPreventionActionOverride\":false,\"isBiocRule\":false,\"biocId\":\"0\",\"additionalData\":\"\",\"biocRuleName\":\"\",\"reachedMaxActivationsPerRule\":false,\"syncActionStatus\":999999,\"spawnerImagePath\":\"C:\\\\Windows\\\\explorer.exe\",\"spawnerCmdline\":\"C:\\\\Windows\\\\Explorer.EXE\",\"spawnerSigner\":\"Microsoft Corporation\",\"osSpawnerImagePath\":\"C:\\\\Windows\\\\explorer.exe\",\"osSpawnerCmdline\":\"C:\\\\Windows\\\\Explorer.EXE\",\"osSpawnerSigner\":\"Microsoft Corporation\",\"containerEscapeData\":{}},\"techniqueId\":[\"T1036.005\"],\"tacticId\":[\"TA0005\",\"TA0002\"],\"remoteActorDetails\":{\"actorType\":1,\"pipeName\":\"\",\"hostname\":\"\",\"endpointIp\":\"\",\"endpointPort\":0,\"endpointDomain\":0,\"cid\":\"AdeJKC1osnkAAArEAAAAAA==\",\"localHostIp\":\"\",\"localHostPort\":0,\"localHostDomain\":0},\"modules\":[],\"additionalContext\":{},\"scriptResults\":{},\"severity\":4,\"terminate\":1,\"block\":0,\"sourceProcessIdx\":0,\"fileIdx\":0,\"canUpload\":0,\"ruleId\":\"bioc.masquerade_svchost\",\"ruleName\":\"bioc.masquerade_svchost\",\"ipBlocked\":0,\"preventionMode\":\"blocked\",\"trapsSeverity\":3,\"profile\":\"Malware\",\"description\":\"Behavioral Threat\",\"cystatusDescription\":\"Behavioral threat detected\",\"sourceProcess\":{\"user\":{\"userName\":\"user\",\"domainUser\":\"user\"},\"pid\":2756,\"parentId\":3324,\"exeFileIdx\":0,\"userIdx\":0,\"commandLine\":\"\\\"C:\\\\Portable\\\\pestudio\\\\svchost.exe\\\" \",\"instanceId\":\"AdeJKC1osnkAAArEAAAAAA==\",\"terminated\":1,\"terminationReportId\":\"68551ca39deb43218d8a2b6a6495d97b\",\"rawFullPath\":\"C:\\\\Portable\\\\pestudio\\\\svchost.exe\",\"fileName\":\"svchost.exe\",\"sha256\":\"c80aa7d807890269968b3a4d00e347a756039d04545e75c312499105c069cf60\",\"fileSize\":\"565248\",\"companyName\":\"www.winitor.com\"},\"policyId\":\"1319b9da83764bd199b93b40457f0eee\"}}"},
        #                                      {"internal_id": 5,
        #                                       "original_alert_json": "{\"uuid\":\"7746a019d98f4dc6a1680eed42f7817b\",\"recordType\":\"threat\",\"customerId\":\"9996491305873\",\"severity\":3,\"generatedTime\":\"2021-08-04T11:59:28.912000Z\",\"originalAgentTime\":\"2021-08-04T11:59:28.465286Z\",\"serverTime\":\"2021-08-04T11:59:30.719746\",\"isEndpoint\":1,\"agentId\":\"7ec89bbb3d9b478dbc176814c133e643\",\"endPointHeader\":{\"osVersion\":\"10.0.10240\",\"agentIp\":\"10.208.254.69\",\"deviceName\":\"DESKTOP-84QH963\",\"agentVersion\":\"7.5.0.27877\",\"contentVersion\":\"192-67380\",\"policyTag\":\"YTdiN2NkOWQyMmViMDY0ZjgyNDdhODlkZGIzN2FjZDEzZDJlMzE4N2NkYzQ5YmVlZTI2ODVlZmY1MjdmYmMwNTpGYWxzZTpESVNBQkxFRDpMSUNFTlNFXzIwX1BSRVZFTlQ=\",\"securityStatus\":0,\"protectionStatus\":0,\"dataCollectionStatus\":0,\"isolationStatus\":0,\"agentIpList\":[\"10.208.254.69\"],\"addresses\":[{\"ip\":[\"10.208.254.69\"],\"mac\":\"00:50:56:89:7b:e8\"}],\"liveTerminalEnabled\":true,\"scriptExecutionEnabled\":true,\"fileRetrievalEnabled\":true,\"agentLocation\":0,\"fileSearchEnabled\":false,\"deviceDomain\":\"WORKGROUP\",\"userName\":\"user\",\"userSid\":\"S-1-5-21-3253057499-604248399-3554933422-1003\",\"osType\":1,\"is64\":1,\"isVdi\":0,\"agentId\":\"7ec89bbb3d9b478dbc176814c133e643\",\"agentTime\":\"2021-08-04T11:59:28.912000Z\",\"tzOffset\":-180},\"messageData\":{\"eventCategory\":\"prevention\",\"moduleId\":\"COMPONENT_DSE\",\"moduleStatusId\":\"CYSTATUS_DSE\",\"preventionKey\":\"8273f1ee45954a028f6378a5b119c4f7\",\"processes\":[{\"pid\":2756,\"parentId\":3324,\"exeFileIdx\":0,\"userIdx\":0,\"commandLine\":\"\\\"C:\\\\Portable\\\\pestudio\\\\svchost.exe\\\" \",\"instanceId\":\"AdeJKC1osnkAAArEAAAAAA==\",\"terminated\":1,\"terminationReportId\":\"68551ca39deb43218d8a2b6a6495d97b\"}],\"files\":[{\"rawFullPath\":\"C:\\\\Portable\\\\pestudio\\\\svchost.exe\",\"fileName\":\"svchost.exe\",\"sha256\":\"c80aa7d807890269968b3a4d00e347a756039d04545e75c312499105c069cf60\",\"fileSize\":\"565248\",\"companyName\":\"www.winitor.com\"}],\"users\":[{\"userName\":\"user\",\"domainUser\":\"user\"}],\"urls\":[],\"postDetected\":0,\"sockets\":[],\"containers\":[],\"dynamicAnalysis\":{\"causalityId\":\"AdeJKC1osnkAAArEAAAAAA==\",\"internals\":[{\"name\":\"process_start\",\"factName\":\"process_start\",\"timestamp\":\"2021-08-04T11:59:28.436046Z\",\"eventId\":\"AAABexEIZrRkwDJLAADHgg==\",\"attributes\":{\"is_cgo\":\"1\",\"parent_cid\":\"\",\"enabled_privileges\":\"8388608\",\"peb32\":\"2127228928\",\"is_embedded_sign\":\"0\",\"rpc_function_opnum\":\"nil\",\"parent_thread_instance_id\":\"AAAAAAAAAAAAAAAAAAAAAA==\",\"remote_causality_actor_ip\":\"nil\",\"canonized_process_image_path\":\"%systemdrive%\\\\portable\\\\pestudio\\\\svchost.exe\",\"scanned_buffer_crc32_stacktrace_call_region_buffer\":\"nil\",\"yara_rules_results_stacktrace_allocation_base_buffer\":\"nil\",\"entry_point_rva\":\"307331\",\"is_stack_pivot\":\"nil\",\"os_parent_pid\":\"3324\",\"image_path_md5\":\"e34f6d6ce26eddd05488219574f9c83f\",\"causality_actor_type\":\"1\",\"timestamp\":\"16280783684360460\",\"is_in_transaction\":\"0\",\"cid\":\"AdeJKC1osnkAAArEAAAAAA==\",\"file_info_description\":\"malware initial assessment - www.winitor.com\",\"actor_type\":\"1\",\"integrity_level\":\"8192\",\"chisq_prob\":\"0\",\"parent_tid\":\"5660\",\"rpc_interface_major_version\":\"nil\",\"dse_internal\":\"nil\",\"process_image_name\":\"svchost.exe\",\"parent_instance_id\":\"AdcwYRSqeNQAAAz8AAAAAA==\",\"entropy\":\"0.791\",\"call_region_base_address\":\"nil\",\"yara_rules_results_stacktrace_call_region_buffer\":\"nil\",\"scanned_buffer_crc32_stacktrace_page_base_buffer\":\"nil\",\"image_base\":\"4063232\",\"sync_id\":\"nil\",\"effective_user_sid\":\"S-1-5-21-3253057499-604248399-3554933422-1003\",\"requested_parent_pid\":\"3324\",\"event_id\":\"AAABexEIZrRkwDJLAADHgg==\",\"rpc_protocol\":\"nil\",\"user_presence\":\"2\",\"shellcode_address\":\"nil\",\"tid\":\"5660\",\"parent_pid\":\"3324\",\"is_sign\":\"3\",\"sync_action\":\"nil\",\"is_remote_session\":\"0\",\"peb\":\"2127192064\",\"process_image_path\":\"c:\\\\portable\\\\pestudio\\\\svchost.exe\",\"command_line\":\"\\\"c:\\\\portable\\\\pestudio\\\\svchost.exe\\\" \",\"scanned_buffer_crc32_stacktrace_allocation_base_buffer\":\"nil\",\"page_base_shellcode_buffer\":\"nil\",\"user_name\":\"desktop-84qh963\\\\user\",\"file_info_legal_copyright\":\"copyright \\u00a9 2009-2019 marc ochsenmeier\",\"os_sig_status\":\"0\",\"is_heavens_gate\":\"nil\",\"is_impersonated\":\"0\",\"os_parent_instance_id\":\"AdcwYRSqeNQAAAz8AAAAAA==\",\"file_info_internal_name\":\"pestudio.exe\",\"stack_trace\":\"nil\",\"is_injected\":\"0\",\"pid\":\"2756\",\"image_path_sha256\":\"c80aa7d807890269968b3a4d00e347a756039d04545e75c312499105c069cf60\",\"thread_context_eip_image_path\":\"nil\",\"montepi_err\":\"0.00908\",\"file_info_company_name\":\"www.winitor.com\",\"file_info_original_name\":\"pestudio.exe\",\"instance_id\":\"AdeJKC1osnkAAArEAAAAAA==\",\"file_obj_flags\":\"704374898754\",\"call_region_shellcode_buffer\":\"nil\",\"file_size\":\"565248\",\"should_obfuscate\":\"0\",\"allocation_base_shellcode_buffer\":\"nil\",\"signer_name\":\"nil\",\"original_command_line\":\"\\\"C:\\\\Portable\\\\pestudio\\\\svchost.exe\\\" \",\"rpc_interface_uuid\":\"nil\",\"yara_rules_results_stacktrace_page_base_buffer\":\"nil\",\"rpc_interface_minor_version\":\"nil\",\"telem\":\"nil\",\"is_trusted_signer\":\"nil\",\"thread_context_eip\":\"nil\",\"requested_parent_instance_id\":\"AdcwYRSqeNQAAAz8AAAAAA==\"},\"processIdx\":0,\"instanceId\":\"AdeJKC1osnkAAArEAAAAAA==\"},{\"name\":\"file_operation\",\"factName\":\"file_operation\",\"timestamp\":\"2021-08-04T11:59:26.748441Z\",\"eventId\":\"AAABexEIYBxkwDJLAADHeQ==\",\"attributes\":{\"shellcode_address\":\"nil\",\"tid\":\"5176\",\"file_type\":\"18\",\"sync_action\":\"nil\",\"actor_pid\":\"3324\",\"scanned_buffer_crc32_stacktrace_allocation_base_buffer\":\"nil\",\"actor_instance_id\":\"AdcwYRSqeNQAAAz8AAAAAA==\",\"page_base_shellcode_buffer\":\"nil\",\"is_heavens_gate\":\"nil\",\"is_impersonated\":\"0\",\"reparse_path\":\"\",\"modification_time\":\"nil\",\"dirty_reason\":\"0\",\"access_time\":\"nil\",\"stack_trace\":\"nil\",\"pid\":\"3324\",\"is_injected\":\"0\",\"thread_context_eip_image_path\":\"nil\",\"actor_thread_instance_id\":\"AAAAAAAAAAAAAAAAAAAAAA==\",\"montepi_err\":\"-1\",\"instance_id\":\"AdcwYRSqeNQAAAz8AAAAAA==\",\"file_size\":\"18446744073709551615\",\"call_region_shellcode_buffer\":\"nil\",\"should_obfuscate\":\"0\",\"create_time\":\"nil\",\"allocation_base_shellcode_buffer\":\"nil\",\"yara_rules_results_stacktrace_page_base_buffer\":\"nil\",\"rpc_interface_uuid\":\"nil\",\"file_name\":\"svchost.exe\",\"file_extension\":\"exe\",\"rpc_interface_minor_version\":\"nil\",\"telem\":\"nil\",\"canonized_file_path\":\"%systemdrive%\\\\portable\\\\pestudio\\\\svchost.exe\",\"file_path_hash\":\"\",\"thread_context_eip\":\"nil\",\"attributes\":\"0\",\"sec_desc\":\"\",\"file_path_md5\":\"\",\"reparse_count\":\"0\",\"rpc_function_opnum\":\"nil\",\"remote_causality_actor_ip\":\"nil\",\"is_remote_file\":\"0\",\"scanned_buffer_crc32_stacktrace_call_region_buffer\":\"nil\",\"yara_rules_results_stacktrace_allocation_base_buffer\":\"nil\",\"old_file_name\":\"pestudio - copy.exe\",\"is_stack_pivot\":\"nil\",\"file_path\":\"c:\\\\portable\\\\pestudio\\\\svchost.exe\",\"sub_type\":\"3\",\"causality_actor_type\":\"1\",\"timestamp\":\"16280783667484410\",\"cid\":\"AdcwYRSqeNQAAAz8AAAAAA==\",\"actor_type\":\"1\",\"chisq_prob\":\"-1\",\"rpc_interface_major_version\":\"nil\",\"dse_internal\":\"nil\",\"old_file_path\":\"c:\\\\portable\\\\pestudio\\\\pestudio - copy.exe\",\"actor_tid\":\"5176\",\"entropy\":\"-1\",\"call_region_base_address\":\"nil\",\"yara_rules_results_stacktrace_call_region_buffer\":\"nil\",\"scanned_buffer_crc32_stacktrace_page_base_buffer\":\"nil\",\"canonized_old_file_path\":\"%systemdrive%\\\\portable\\\\pestudio\\\\pestudio - copy.exe\",\"sync_id\":\"nil\",\"event_id\":\"AAABexEIYBxkwDJLAADHeQ==\",\"rpc_protocol\":\"nil\"},\"processIdx\":-1,\"instanceId\":\"AdcwYRSqeNQAAAz8AAAAAA==\"},{\"name\":\"process_start\",\"factName\":\"process_start\",\"timestamp\":\"2021-04-13T12:32:34.739630Z\",\"eventId\":\"AAABeMs4GbNkwDJLAAAF/A==\",\"attributes\":{\"is_cgo\":\"1\",\"parent_cid\":\"\",\"enabled_privileges\":\"8388608\",\"peb32\":\"0\",\"is_embedded_sign\":\"1\",\"rpc_function_opnum\":\"nil\",\"parent_thread_instance_id\":\"AAAAAAAAAAAAAAAAAAAAAA==\",\"remote_causality_actor_ip\":\"nil\",\"canonized_process_image_path\":\"%windir%\\\\explorer.exe\",\"scanned_buffer_crc32_stacktrace_call_region_buffer\":\"nil\",\"yara_rules_results_stacktrace_allocation_base_buffer\":\"nil\",\"entry_point_rva\":\"653472\",\"is_stack_pivot\":\"nil\",\"os_parent_pid\":\"3252\",\"image_path_md5\":\"10e4809ba77d58392c742097dd61e1a6\",\"causality_actor_type\":\"1\",\"timestamp\":\"16183171547396300\",\"is_in_transaction\":\"0\",\"cid\":\"AdcwYRSqeNQAAAz8AAAAAA==\",\"file_info_description\":\"windows explorer\",\"actor_type\":\"1\",\"integrity_level\":\"8192\",\"chisq_prob\":\"0\",\"parent_tid\":\"4294967295\",\"rpc_interface_major_version\":\"nil\",\"dse_internal\":\"nil\",\"process_image_name\":\"explorer.exe\",\"parent_instance_id\":\"AdcwYRSbqvQAAAy0AAAAAA==\",\"entropy\":\"0.738\",\"call_region_base_address\":\"nil\",\"yara_rules_results_stacktrace_call_region_buffer\":\"nil\",\"scanned_buffer_crc32_stacktrace_page_base_buffer\":\"nil\",\"image_base\":\"140698412187648\",\"sync_id\":\"nil\",\"effective_user_sid\":\"S-1-5-21-3253057499-604248399-3554933422-1003\",\"requested_parent_pid\":\"3252\",\"event_id\":\"AAABeMs4GbNkwDJLAAAF/A==\",\"rpc_protocol\":\"nil\",\"user_presence\":\"0\",\"shellcode_address\":\"nil\",\"tid\":\"4294967295\",\"parent_pid\":\"3252\",\"is_sign\":\"1\",\"sync_action\":\"nil\",\"is_remote_session\":\"0\",\"peb\":\"140698407071744\",\"process_image_path\":\"c:\\\\windows\\\\explorer.exe\",\"command_line\":\"c:\\\\windows\\\\explorer.exe\",\"scanned_buffer_crc32_stacktrace_allocation_base_buffer\":\"nil\",\"page_base_shellcode_buffer\":\"nil\",\"user_name\":\"desktop-84qh963\\\\user\",\"file_info_legal_copyright\":\"\\u00a9 microsoft corporation. all rights reserved.\",\"os_sig_status\":\"2\",\"is_heavens_gate\":\"nil\",\"is_impersonated\":\"0\",\"os_parent_instance_id\":\"AdcwYRSbqvQAAAy0AAAAAA==\",\"file_info_internal_name\":\"explorer\",\"stack_trace\":\"nil\",\"is_injected\":\"0\",\"pid\":\"3324\",\"image_path_sha256\":\"4c36f49d7e09f39b9034a24b9ee496e8f4dc3044a89514dc890e139708fc94f6\",\"thread_context_eip_image_path\":\"nil\",\"montepi_err\":\"0.0749\",\"file_info_company_name\":\"microsoft corporation\",\"file_info_original_name\":\"explorer.exe\",\"instance_id\":\"AdcwYRSqeNQAAAz8AAAAAA==\",\"file_obj_flags\":\"704374915138\",\"call_region_shellcode_buffer\":\"nil\",\"file_size\":\"4533320\",\"should_obfuscate\":\"0\",\"allocation_base_shellcode_buffer\":\"nil\",\"signer_name\":\"Microsoft Corporation\",\"original_command_line\":\"C:\\\\Windows\\\\Explorer.EXE\",\"rpc_interface_uuid\":\"nil\",\"yara_rules_results_stacktrace_page_base_buffer\":\"nil\",\"rpc_interface_minor_version\":\"nil\",\"telem\":\"nil\",\"is_trusted_signer\":\"0\",\"thread_context_eip\":\"nil\",\"requested_parent_instance_id\":\"AdcwYRSbqvQAAAy0AAAAAA==\"},\"processIdx\":-1,\"instanceId\":\"AdcwYRSqeNQAAAz8AAAAAA==\"},{\"name\":\"internal.debug_build_timestamp\",\"factName\":\"internal.debug_build_timestamp\",\"timestamp\":\"2021-04-13T12:31:57.022749Z\",\"eventId\":\"\",\"attributes\":{\"timestamp\":\"16183171170227490\",\"cid\":\"AdcwYP4vVSsAAAAEAAAAAA==\",\"prio\":\"1000\",\"build_timestamp\":\"1627909023\"},\"processIdx\":-1,\"instanceId\":\"\"}],\"potentialPreventionActionOverride\":false,\"isBiocRule\":false,\"biocId\":\"0\",\"additionalData\":\"\",\"biocRuleName\":\"\",\"reachedMaxActivationsPerRule\":false,\"syncActionStatus\":999999,\"spawnerImagePath\":\"C:\\\\Windows\\\\explorer.exe\",\"spawnerCmdline\":\"C:\\\\Windows\\\\Explorer.EXE\",\"spawnerSigner\":\"Microsoft Corporation\",\"osSpawnerImagePath\":\"C:\\\\Windows\\\\explorer.exe\",\"osSpawnerCmdline\":\"C:\\\\Windows\\\\Explorer.EXE\",\"osSpawnerSigner\":\"Microsoft Corporation\",\"containerEscapeData\":{}},\"techniqueId\":[\"T1036.005\"],\"tacticId\":[\"TA0005\",\"TA0002\"],\"remoteActorDetails\":{\"actorType\":1,\"pipeName\":\"\",\"hostname\":\"\",\"endpointIp\":\"\",\"endpointPort\":0,\"endpointDomain\":0,\"cid\":\"AdeJKC1osnkAAArEAAAAAA==\",\"localHostIp\":\"\",\"localHostPort\":0,\"localHostDomain\":0},\"modules\":[],\"additionalContext\":{},\"scriptResults\":{},\"severity\":4,\"terminate\":1,\"block\":0,\"sourceProcessIdx\":0,\"fileIdx\":0,\"canUpload\":0,\"ruleId\":\"bioc.masquerade_svchost\",\"ruleName\":\"bioc.masquerade_svchost\",\"ipBlocked\":0,\"preventionMode\":\"blocked\",\"trapsSeverity\":3,\"profile\":\"Malware\",\"description\":\"Behavioral Threat\",\"cystatusDescription\":\"Behavioral threat detected\",\"sourceProcess\":{\"user\":{\"userName\":\"user\",\"domainUser\":\"user\"},\"pid\":2756,\"parentId\":3324,\"exeFileIdx\":0,\"userIdx\":0,\"commandLine\":\"\\\"C:\\\\Portable\\\\pestudio\\\\svchost.exe\\\" \",\"instanceId\":\"AdeJKC1osnkAAArEAAAAAA==\",\"terminated\":1,\"terminationReportId\":\"68551ca39deb43218d8a2b6a6495d97b\",\"rawFullPath\":\"C:\\\\Portable\\\\pestudio\\\\svchost.exe\",\"fileName\":\"svchost.exe\",\"sha256\":\"c80aa7d807890269968b3a4d00e347a756039d04545e75c312499105c069cf60\",\"fileSize\":\"565248\",\"companyName\":\"www.winitor.com\"},\"policyId\":\"1319b9da83764bd199b93b40457f0eee\"}}"}]}}
        if not raw_response:
            raise DemistoException('No raw response received.')
        raw_response = raw_response.get('reply', {})
        raw_response_copy = copy.deepcopy(raw_response)
        alerts = raw_response.get('alerts', [])
        decode_alerts(alerts)
        filtered_alerts = filter_alerts(alerts)
        readable_output = create_readable_format(filtered_alerts)

        return_results(CommandResults(
            readable_output=readable_output,
            outputs_prefix='PaloAltoNetworksXDR.GenericExecution.BTPAlerts',
            outputs_key_field='internal_id',
            outputs=filtered_alerts,
            raw_response=raw_response_copy,
        ))

    except Exception as exc:
        return_error(f'Failed to execute XDRFetchingBTP.\nError: {exc}', error=exc)


if __name__ in ('__main__', '__builtin__', 'builtins'):
    main()
